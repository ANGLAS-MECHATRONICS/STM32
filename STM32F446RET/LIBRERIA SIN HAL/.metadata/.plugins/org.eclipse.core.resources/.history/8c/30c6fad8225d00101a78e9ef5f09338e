/*
 *	–î—Ä–∞–π–≤–µ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏—Å–ø–ª–µ—è–º–∏ –ø–æ SPI
 *  Author: VadRov
 *  Copyright (C) 2019 - 2022, VadRov, all right reserved.
 *
 *  –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ —Ü–µ–ª–µ–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
 *  –ü—Ä–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å –∞–≤—Ç–æ—Ä–æ–º.
 *  –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—Å—è –ø–æ —Ç–∏–ø—É "–∫–∞–∫ –µ—Å—Ç—å", —Ç–æ –µ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç–µ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.
 *  –ê–≤—Ç–æ—Ä –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π.
 *
 *  –í–µ—Ä—Å–∏—è: 1.4 (–Ω–∞ CMSIS –∏ LL) –¥–ª—è STM32F4
 *
 *  https://www.youtube.com/@VadRov
 *  https://dzen.ru/vadrov
 *  https://vk.com/vadrov
 *  https://t.me/vadrov_channel
 *
 */

#include "display.h"
#include "fonts.h"
#include <string.h>
#ifdef LCD_DYNAMIC_MEM
#include "stdlib.h"
#endif

#define ABS(x) ((x) > 0 ? (x) : -(x))

#define min(x1,x2)	(x1 < x2 ? x1 : x2)
#define max(x1,x2)	(x1 > x2 ? x1 : x2)

#define min3(x1,x2,x3)	min(min(x1,x2),x3)
#define max3(x1,x2,x3)	max(max(x1,x2),x3)

#define LCD_CS_LOW		if (lcd->spi_data.cs_port) { lcd->spi_data.cs_port->BSRR = (uint32_t)lcd->spi_data.cs_pin << 16U; }
#define LCD_CS_HI		if (lcd->spi_data.cs_port) { lcd->spi_data.cs_port->BSRR = lcd->spi_data.cs_pin; }
#define LCD_DC_LOW		{lcd->spi_data.dc_port->BSRR = (uint32_t)lcd->spi_data.dc_pin << 16U; }
#define LCD_DC_HI		{lcd->spi_data.dc_port->BSRR = lcd->spi_data.dc_pin; }

#define DISABLE_IRQ		__disable_irq(); __DSB(); __ISB();
#define ENABLE_IRQ		__enable_irq();

LCD_Handler *LCD = 0; //—Å–ø–∏—Å–æ–∫ –¥–∏—Å–ø–ª–µ–µ–≤

//–∫–æ–ª–ª–±—ç–∫ –ø–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—é –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏
//—ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –≤ –ø–æ—Ç–æ–∫–∞—Ö DMA,
//–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∏—Å–ø–ª–µ—è–º–∏ - stm32f4xx_it.c
void Display_TC_Callback(DMA_TypeDef *dma_x, uint32_t stream)
{
	//—Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
	uint8_t shift[8] = {0, 6, 16, 22, 0, 6, 16, 22}; //–±–∏—Ç–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤–æ —Ñ–ª–∞–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ IFCR (L –∏ H)
	volatile uint32_t *ifcr_tx = (stream > 3) ? &(dma_x->HIFCR) : &(dma_x->LIFCR);
	*ifcr_tx = 0x3F<<shift[stream];
	uint32_t stream_ct = 0;
	DMA_TypeDef *dma_ct = 0;
	LCD_Handler *lcd = LCD; //—É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–∏—Å–ø–ª–µ–π –≤ —Å–ø–∏—Å–∫–µ
	//–ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–ø–∏—Å–∫—É –¥–∏—Å–ø–ª–µ–µ–≤ (–ø–æ–∫–∞ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤ —Å–ø–∏—Å–∫–µ)
	while (lcd) {
		//–ø–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã DMA –ø–æ—Ç–æ–∫–∞ –¥–∏—Å–ø–ª–µ—è
		dma_ct = lcd->spi_data.dma_tx.dma;
		stream_ct = lcd->spi_data.dma_tx.stream;
		//–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞ DMA –ø–æ—Ç–æ–∫—É, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω i-—Ç—ã–π –¥–∏—Å–ø–ª–µ–π
		if (dma_ct == dma_x && stream_ct == stream) {
			if (lcd->spi_data.cs_port) {//—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ cs –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è?
				//–Ω–∞ –≤—ã–≤–æ–¥–µ cs –¥–∏—Å–ø–ª–µ—è –Ω–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å?
				if (lcd->spi_data.cs_port->ODR & lcd->spi_data.cs_pin) { //–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∏–Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –ø–æ—Ä—Ç–∞
					lcd = (LCD_Handler *)lcd->next;		   //–µ—Å–ª–∏ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å cs, —Ç–æ –Ω–µ —ç—Ç–æ—Ç –¥–∏—Å–ø–ª–µ–π –∞–∫—Ç–∏–≤–µ–Ω
					continue;							   //–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
				}
			}
			//—É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–æ—Ç–æ–∫: a–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ + —Å–º–µ—â–µ–Ω–∏–µ
			DMA_Stream_TypeDef *dma_TX = ((DMA_Stream_TypeDef *)((uint32_t)((uint32_t)dma_x + STREAM_OFFSET_TAB[stream])));
			//–≤—ã–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫ DMA
			dma_TX->CR &= ~DMA_SxCR_EN;
			while (dma_TX->CR & DMA_SxCR_EN) ; //–∂–¥–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
			if (lcd->size_mem) { //–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –Ω–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏, —Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º DMA –∏ –≤—ã—Ö–æ–¥–∏–º –∏–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
				if (lcd->size_mem > 65535) {
					dma_TX->NDTR = 65535;
					lcd->size_mem -= 65535;
				}
				else {
					dma_TX->NDTR = lcd->size_mem;
					lcd->size_mem = 0;
				}
				//–≤–∫–ª—é—á–∞–µ–º –ø–æ—Ç–æ–∫ DMA
				dma_TX->CR |= (DMA_SxCR_EN);
				return;
			}
#ifdef LCD_DYNAMIC_MEM
			//–æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –¥–∏—Å–ø–ª–µ—è
			if (lcd->tmp_buf) {
		    	//—Ç–∞–∫ –∫–∞–∫ –ø–∞–º—è—Ç—å –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, —Ç–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π,
				//—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–ª–ª–∏–∑–∏–π, –∑–∞–ø—Ä–µ—Ç–∏–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
				DISABLE_IRQ
				free(lcd->tmp_buf);
				lcd->tmp_buf = 0;
				ENABLE_IRQ
			}
#endif
			//–∑–∞–ø—Ä–µ—â–∞–µ–º SPI –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ DMA
			lcd->spi_data.spi->CR2 &= ~SPI_CR2_TXDMAEN;
			while (lcd->spi_data.spi->SR & SPI_SR_BSY) ; //–∂–¥–µ–º –ø–æ–∫–∞ SPI –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
			//–æ—Ç–∫–ª—é—á–∞–µ–º –¥–∏—Å–ø–ª–µ–π –æ—Ç MK (–ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º –≤—ã–≤–æ–¥ CS –¥–∏—Å–ø–ª–µ—è –∫ –≤—ã—Å–æ–∫–æ–º—É —É—Ä–æ–≤–Ω—é)
			if (!lcd->cs_control) { LCD_CS_HI }
			//–≤—ã–∫–ª—é—á–∞–µ–º spi
			lcd->spi_data.spi->CR1 &= ~SPI_CR1_SPE;
			return;
		}
		//–ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–∏—Å–ø–ª–µ—é –≤ —Å–ø–∏—Å–∫–µ
		lcd = (LCD_Handler *)lcd->next;
	}
}

inline void LCD_SetCS(LCD_Handler *lcd)
{
	LCD_CS_HI
}

inline void LCD_ResCS(LCD_Handler *lcd)
{
	LCD_CS_LOW
}

inline void LCD_SetDC(LCD_Handler *lcd)
{
	LCD_DC_HI
}

inline void LCD_ResDC(LCD_Handler *lcd)
{
	LCD_DC_LOW
}

typedef enum {
	lcd_write_command = 0,
	lcd_write_data
} lcd_dc_select;

inline static void LCD_WRITE_DC(LCD_Handler* lcd, uint8_t data, lcd_dc_select lcd_dc)
{
	SPI_TypeDef *spi = lcd->spi_data.spi;
	if (lcd_dc == lcd_write_command)  {
		LCD_DC_LOW
	}
	else {
		LCD_DC_HI
	}
	LL_SPI_TransmitData8(spi, data);
	while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
	while (spi->SR & SPI_SR_BSY)    ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ SPI –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
}

void LCD_HardWareReset (LCD_Handler* lcd)
{
	if (lcd->spi_data.reset_port) {
		lcd->spi_data.reset_port->BSRR = (uint32_t)lcd->spi_data.reset_pin << 16U;
		LL_mDelay(25);
		lcd->spi_data.reset_port->BSRR = lcd->spi_data.reset_pin;
		LL_mDelay(25);
	}
}

//–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä —Å—Ç—Ä–æ–∫ —Å —É–ø—Ä–∞–≤–ª—è—â–∏–º–∏ –∫–æ–¥–∞–º–∏: "–∫–æ–º–∞–Ω–¥–∞", "–¥–∞–Ω–Ω—ã–µ", "–ø–∞—É–∑–∞", "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞"
void LCD_String_Interpretator(LCD_Handler* lcd, uint8_t *str)
{
	SPI_TypeDef *spi = lcd->spi_data.spi;
	int i;
	while (LCD_GetState(lcd) == LCD_STATE_BUSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ –¥–∏—Å–ø–ª–µ–π –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
	if (!lcd->cs_control) { LCD_CS_LOW }
	spi->CR1 &= ~ (SPI_CR1_BIDIMODE |  	//–∑–¥–µ—Å—å –∑–∞–¥–∞–µ–º —Ä–µ–∂–∏–º
				   SPI_CR1_RXONLY |   	//  Transmit only
				   SPI_CR1_CRCEN | 		//–≤—ã–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç CRC
				   SPI_CR1_DFF); 		//—É—Å—Ç–∞–Ω–æ–≤–∏–º 8-–±–∏—Ç–Ω—É—é –ø–µ—Ä–µ–¥–∞—á—É
	spi->CR1 |= SPI_CR1_SPE; // SPI –≤–∫–ª—é—á–∞–µ–º
	while (1) {
		switch (*str++) {
			//—É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∫–æ–¥ "–∫–æ–º–∞–Ω–¥–∞"
			case LCD_UPR_COMMAND:
				//–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –¥–∏—Å–ø–ª–µ—è
				LCD_WRITE_DC(lcd, *str++, lcd_write_command);
				//–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥—ã
				i = *str++;
				//–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –¥–∏—Å–ø–ª–µ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥—ã
				while(i--) {
					LCD_WRITE_DC(lcd, *str++, lcd_write_data);
				}
				break;
			//—É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∫–æ–¥ "–¥–∞–Ω–Ω—ã–µ"
			case LCD_UPR_DATA:
				//–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö
				i = *str++;
				//–æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –¥–∏—Å–ø–ª–µ—è –¥–∞–Ω–Ω—ã–µ
				while(i--) {
					LCD_WRITE_DC(lcd, *str++, lcd_write_data);
				}
				break;
			//—É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∫–æ–¥ "–ø–∞—É–∑–∞"
			case LCD_UPR_PAUSE:
				//–æ–∂–∏–¥–∞–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º (0...255)
				LL_mDelay(*str++);
				break;
			//—É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∫–æ–¥ "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞"
			case LCD_UPR_END:
			default:
				if (!lcd->cs_control) { LCD_CS_HI }
				//–≤—ã–∫–ª—é—á–∞–µ–º spi
				spi->CR1 &= ~SPI_CR1_SPE;
				return;
		}
	}
}

//—Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–∏—Å–ø–ª–µ—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–≥–æ –≤ —Å–ø–∏—Å–æ–∫ –¥–∏—Å–ø–ª–µ–µ–≤ lcds
//–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–∏–±–æ 0 –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
LCD_Handler* LCD_DisplayAdd(LCD_Handler *lcds,     /* —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–ø–∏—Å–æ–∫ –¥–∏—Å–ø–ª–µ–µ–≤
													  (–ø–µ—Ä–≤—ã–π –¥–∏—Å–ø–ª–µ–π –≤ —Å–ø–∏—Å–∫–µ) */
#ifndef LCD_DYNAMIC_MEM
							LCD_Handler *lcd,	   /* —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏—Å–ø–ª–µ—è
													  –≤ —Å–ª—É—á–∞–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ */
#endif
							uint16_t resolution1,
							uint16_t resolution2,
							uint16_t width_controller,
							uint16_t height_controller,
							int16_t w_offs,
							int16_t h_offs,
							LCD_PageOrientation orientation,
							DisplayInitCallback init,
							DisplaySetWindowCallback set_win,
							DisplaySleepInCallback sleep_in,
							DisplaySleepOutCallback sleep_out,
							void *connection_data,
							LCD_DATA_BUS data_bus,
							LCD_BackLight_data bkl_data
					   )
{
#ifdef LCD_DYNAMIC_MEM
	LCD_Handler* lcd = (LCD_Handler*)malloc(sizeof(LCD_Handler));
#endif
	if (!lcd) return 0;
	memset(lcd, 0, sizeof(LCD_Handler));
	LCD_DMA_TypeDef *hdma = 0;
	lcd->data_bus = data_bus;
	//–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
	lcd->spi_data = *((LCD_SPI_Connected_data*)connection_data);
	hdma = &lcd->spi_data.dma_tx;
	//–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DMA
	if (hdma->dma) {
		DMA_Stream_TypeDef *dma_x = ((DMA_Stream_TypeDef *)((uint32_t)((uint32_t)hdma->dma + STREAM_OFFSET_TAB[hdma->stream])));
		dma_x->CR &= ~DMA_SxCR_EN; //–æ—Ç–∫–ª—é—á–∞–µ–º –∫–∞–Ω–∞–ª DMA
		while(dma_x->CR & DMA_SxCR_EN) ; //–∂–¥–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞
		if (lcd->data_bus == LCD_DATA_8BIT_BUS) {
			dma_x->CR &= ~(DMA_SxCR_MSIZE | DMA_SxCR_PSIZE);
			dma_x->CR |= LL_DMA_MDATAALIGN_BYTE | LL_DMA_PDATAALIGN_BYTE;
		}
		else if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
			dma_x->CR &= ~(DMA_SxCR_MSIZE | DMA_SxCR_PSIZE);
			dma_x->CR |= LL_DMA_MDATAALIGN_HALFWORD | LL_DMA_PDATAALIGN_HALFWORD;
		}
		//–∑–∞–ø—Ä–µ—â–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–º —Å–æ–±—ã—Ç–∏—è–º –∫–∞–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥–∞—á–∏ tx –∏ —Ä–µ–∂–∏–º –¥–≤–æ–π–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞
		dma_x->CR &= ~(DMA_SxCR_DMEIE | DMA_SxCR_HTIE | DMA_SxCR_DBM | DMA_SxCR_TEIE);
		dma_x->FCR &= ~DMA_SxFCR_FEIE;
		//—Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –ø–µ—Ä–µ–¥–∞—á–∏
		dma_x->CR |= DMA_SxCR_TCIE;
		dma_x->CR &= ~DMA_SxCR_PINC; //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω
		dma_x->CR |= DMA_SxCR_MINC;  //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–∞–º—è—Ç–∏ –≤–∫–ª—é—á–µ–Ω
	}
	//–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –¥–∏—Å–ø–ª–µ—è –∏ —Å–º–µ—â–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
	uint16_t max_res = max(resolution1, resolution2);
	uint16_t min_res = min(resolution1, resolution2);
	if (orientation==PAGE_ORIENTATION_PORTRAIT || orientation==PAGE_ORIENTATION_PORTRAIT_MIRROR) {
		lcd->Width = min_res;
		lcd->Height = max_res;
		lcd->Width_Controller = width_controller;
		lcd->Height_Controller = height_controller;
		if (orientation==PAGE_ORIENTATION_PORTRAIT) {
			lcd->x_offs = w_offs;
			lcd->y_offs = h_offs;
		}
		else {
			lcd->x_offs = lcd->Width_Controller - lcd->Width - w_offs;
			lcd->y_offs = lcd->Height_Controller - lcd->Height - h_offs;
		}
	}
	else if (orientation==PAGE_ORIENTATION_LANDSCAPE || orientation==PAGE_ORIENTATION_LANDSCAPE_MIRROR)	{
		lcd->Width = max_res;
		lcd->Height = min_res;
		lcd->Width_Controller = height_controller;
		lcd->Height_Controller = width_controller;
		if (orientation==PAGE_ORIENTATION_LANDSCAPE) {
			lcd->x_offs = h_offs;
			lcd->y_offs = lcd->Height_Controller - lcd->Height - w_offs;
		}
		else {
			lcd->x_offs = lcd->Width_Controller - lcd->Width - h_offs;
			lcd->y_offs = w_offs;
		}
	}
	else {
		LCD_Delete(lcd);
		return 0;
	}

	if (lcd->Width_Controller < lcd->Width ||
		lcd->Height_Controller < lcd->Height ||
		init==NULL ||
		set_win==NULL )	{
		LCD_Delete(lcd);
		return 0;
	}
	lcd->Orientation = orientation;
	lcd->Init_callback = init;
	lcd->SetActiveWindow_callback = set_win;
	lcd->SleepIn_callback = sleep_in;
	lcd->SleepOut_callback = sleep_out;
	lcd->bkl_data = bkl_data;
	lcd->display_number = 0;
	lcd->next = 0;
	lcd->prev = 0;
	lcd->tmp_buf = 0;
	if (!lcds) {
		return lcd;
	}
	LCD_Handler *prev = lcds;
	while (prev->next) {
		prev = (LCD_Handler *)prev->next;
		lcd->display_number++;
	}
	lcd->prev = (void*)prev;
	prev->next = (void*)lcd;
	return lcd;
}

//—É–¥–∞–ª—è–µ—Ç –¥–∏—Å–ø–ª–µ–π
void LCD_Delete(LCD_Handler* lcd)
{
	if (lcd) {
#ifdef LCD_DYNAMIC_MEM
		if (lcd->tmp_buf) {
			free(lcd->tmp_buf);
		}
#endif
		memset(lcd, 0, sizeof(LCD_Handler));
#ifdef LCD_DYNAMIC_MEM
		free(lcd);
#endif
	}
}

//–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏—Å–ø–ª–µ–π
void LCD_Init(LCD_Handler* lcd)
{
	LCD_HardWareReset(lcd);
	LCD_String_Interpretator(lcd, lcd->Init_callback(lcd->Orientation));
	LCD_SetBackLight(lcd, lcd->bkl_data.bk_percent);
}

//–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —è—Ä–∫–æ—Å—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏, %
inline uint8_t LCD_GetBackLight(LCD_Handler* lcd)
{
	return lcd->bkl_data.bk_percent;
}

//–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à–∏—Ä–∏–Ω—É –¥–∏—Å–ø–ª–µ—è, –ø–∏–∫—Å–µ–ª–∏
inline uint16_t LCD_GetWidth(LCD_Handler* lcd)
{
	return lcd->Width;
}

//–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã—Å–æ—Ç—É –¥–∏—Å–ø–ª–µ—è, –ø–∏–∫—Å–µ–ª–∏
inline uint16_t LCD_GetHeight(LCD_Handler* lcd)
{
	return lcd->Height;
}

//–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–∏—Å–ø–ª–µ—è: –∑–∞–Ω—è—Ç –ª–∏–±–æ —Å–≤–æ–±–æ–¥–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–ø–ª–µ–π)
//–¥–∏—Å–ø–ª–µ–π –∑–∞–Ω—è—Ç, –µ—Å–ª–∏ –∑–∞–Ω—è—Ç–æ spi, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω
inline LCD_State LCD_GetState(LCD_Handler* lcd)
{
	if (lcd->spi_data.spi->CR1 & SPI_CR1_SPE) {
		return LCD_STATE_BUSY;
	}
	return LCD_STATE_READY;
}

//—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
void LCD_SetBackLight(LCD_Handler* lcd, uint8_t bk_percent)
{
	if (bk_percent > 100) {
		bk_percent = 100;
	}
	lcd->bkl_data.bk_percent = bk_percent;
	//–ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PWM
	if (lcd->bkl_data.htim_bk) {
		//–≤—ã—á–∏—Å–ª—è–µ–º % —è—Ä–∫–æ—Å—Ç–∏, –∫–∞–∫ —á–∞—Å—Ç—å –æ—Ç –ø–µ—Ä–∏–æ–¥–∞ —Å—á–µ—Ç—á–∏–∫–∞
		uint32_t bk_value = lcd->bkl_data.htim_bk->ARR * bk_percent / 100;
		//–∑–∞–¥–∞–µ–º —Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å PWM –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
		switch(lcd->bkl_data.channel_htim_bk) {
			case LL_TIM_CHANNEL_CH1:
				lcd->bkl_data.htim_bk->CCR1 = bk_value;
				break;
			case LL_TIM_CHANNEL_CH2:
				lcd->bkl_data.htim_bk->CCR2 = bk_value;
				break;
			case LL_TIM_CHANNEL_CH3:
				lcd->bkl_data.htim_bk->CCR3 = bk_value;
				break;
			case LL_TIM_CHANNEL_CH4:
				lcd->bkl_data.htim_bk->CCR4 = bk_value;
				break;
			default:
				break;
		}
		//–µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, —Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
		if (!(lcd->bkl_data.htim_bk->CR1 & TIM_CR1_CEN)) {
			//–≤–∫–ª—é—á–∞–µ–º –∫–∞–Ω–∞–ª
			lcd->bkl_data.htim_bk->CCER |= lcd->bkl_data.channel_htim_bk;
			//–≤–∫–ª—é—á–∞–µ–º —Å—á–µ—Ç—á–∏–∫
			lcd->bkl_data.htim_bk->CR1 |= TIM_CR1_CEN;
		}
	}
	//–ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±–µ–∑ PWM (–ø—Ä–æ—Å—Ç–æ –≤–∫–ª./–≤—ã–∫–ª.), –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —Å PWM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
	else if (lcd->bkl_data.blk_port) {
		if (bk_percent) {
			lcd->bkl_data.blk_port->BSRR = lcd->bkl_data.blk_pin;
		}
		else {
			lcd->bkl_data.blk_port->BSRR = (uint32_t)lcd->bkl_data.blk_pin << 16U;
		}
	}
}

//–ø–µ—Ä–µ–≤–æ–¥ –¥–∏—Å–ø–ª–µ—è –≤ "—Å–ø—è—â–∏–π —Ä–µ–∂–∏–º" (–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏—Å–ø–ª–µ—è –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏)
void LCD_SleepIn(LCD_Handler* lcd)
{
	//–ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PWM
	if (lcd->bkl_data.htim_bk) {
		//–≤—ã–∫–ª—é—á–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –Ω—É–ª–µ–≤—É—é —Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å
		switch(lcd->bkl_data.channel_htim_bk) {
			case LL_TIM_CHANNEL_CH1:
				lcd->bkl_data.htim_bk->CCR1 = 0;
				break;
			case LL_TIM_CHANNEL_CH2:
				lcd->bkl_data.htim_bk->CCR2 = 0;
				break;
			case LL_TIM_CHANNEL_CH3:
				lcd->bkl_data.htim_bk->CCR3 = 0;
				break;
			case LL_TIM_CHANNEL_CH4:
				lcd->bkl_data.htim_bk->CCR4 = 0;
				break;
			default:
				break;
		}
	}
	//–ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±–µ–∑ PWM (–ø—Ä–æ—Å—Ç–æ –≤–∫–ª./–≤—ã–∫–ª.), –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä —Å PWM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
	else if (lcd->bkl_data.blk_port) {
		lcd->bkl_data.blk_port->BSRR = (uint32_t)lcd->bkl_data.blk_pin << 16U;
	}
	if (lcd->SleepIn_callback) {
		LCD_String_Interpretator(lcd, lcd->SleepIn_callback());
	}
}

//–≤—ã–≤–æ–¥ –¥–∏—Å–ø–ª–µ—è –∏–∑ "—Å–ø—è—â–µ–≥–æ —Ä–µ–∂–∏–º–∞" (–≤–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏—Å–ø–ª–µ—è –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏)
void LCD_SleepOut(LCD_Handler* lcd)
{
	if (lcd->SleepOut_callback) {
		LCD_String_Interpretator(lcd, lcd->SleepOut_callback());
	}
	//–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
	LCD_SetBackLight(lcd, lcd->bkl_data.bk_percent);
}

//—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –¥–∏—Å–ø–ª–µ–µ –æ–∫–Ω–∞ –≤—ã–≤–æ–¥–∞
void LCD_SetActiveWindow(LCD_Handler* lcd, uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2)
{
	LCD_String_Interpretator(lcd, lcd->SetActiveWindow_callback(x1 + lcd->x_offs, y1 + lcd->y_offs, x2 + lcd->x_offs, y2 + lcd->y_offs));
}

//–≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–ø–ª–µ–π
void LCD_WriteData(LCD_Handler *lcd, uint16_t *data, uint32_t len)
{
	SPI_TypeDef *spi = lcd->spi_data.spi;
	while (LCD_GetState(lcd) == LCD_STATE_BUSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ –¥–∏—Å–ø–ª–µ–π –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
	if (!lcd->cs_control) { LCD_CS_LOW }
	if (!lcd->dc_control) { LCD_DC_HI  }
	spi->CR1 &= ~ (SPI_CR1_BIDIMODE |  	//–∑–¥–µ—Å—å –∑–∞–¥–∞–µ–º —Ä–µ–∂–∏–º
				   SPI_CR1_RXONLY |   	//  Transmit only
				   SPI_CR1_CRCEN | 		//–≤—ã–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç CRC
				   SPI_CR1_DFF); 		//8-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
	if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
		spi->CR1 |= SPI_CR1_DFF; //16-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
	}
	spi->CR1 |= SPI_CR1_SPE; //SPI –≤–∫–ª—é—á–∞–µ–º
	if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
		while (len--) {
			LL_SPI_TransmitData16(spi, *data++); //–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä
			while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
		}
	}
	else {
		len *= 2;
		uint8_t *data1 = (uint8_t*)data;
		while (len--)	{
			LL_SPI_TransmitData8(spi, *data1++); //–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä
			while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
		}
	}
	while (spi->SR & SPI_SR_BSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ SPI –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
	if (!lcd->cs_control) { LCD_CS_HI }
	//–≤—ã–∫–ª—é—á–∞–µ–º spi
	spi->CR1 &= ~SPI_CR1_SPE;
}

//–≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–ø–ª–µ–π —Å DMA
void LCD_WriteDataDMA(LCD_Handler *lcd, uint16_t *data, uint32_t len)
{
	if (lcd->spi_data.dma_tx.dma) {
		if (lcd->data_bus == LCD_DATA_8BIT_BUS) {
			len *= 2;
		}
		SPI_TypeDef *spi = lcd->spi_data.spi;
		while (LCD_GetState(lcd) == LCD_STATE_BUSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ –¥–∏—Å–ø–ª–µ–π –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
		if (!lcd->cs_control) { LCD_CS_LOW }
		if (!lcd->dc_control) { LCD_DC_HI  }
		lcd->size_mem = len;
		spi->CR1 &= ~ (SPI_CR1_BIDIMODE |  	//–∑–¥–µ—Å—å –∑–∞–¥–∞–µ–º —Ä–µ–∂–∏–º
					   SPI_CR1_RXONLY |   	//  Transmit - –ø–µ—Ä–µ–¥–∞—á–∞
					   SPI_CR1_CRCEN | 		//–≤—ã–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç CRC
					   SPI_CR1_DFF); 		//8-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
		if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
			spi->CR1 |= SPI_CR1_DFF; //16-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
		}
		spi->CR1 |= SPI_CR1_SPE; //SPI –≤–∫–ª—é—á–∞–µ–º
		DMA_TypeDef *dma_x = lcd->spi_data.dma_tx.dma;
		uint32_t stream = lcd->spi_data.dma_tx.stream;
		DMA_Stream_TypeDef *dma_TX = ((DMA_Stream_TypeDef *)((uint32_t)((uint32_t)dma_x + STREAM_OFFSET_TAB[stream])));
		uint8_t shift[8] = {0, 6, 16, 22, 0, 6, 16, 22}; //–±–∏—Ç–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤–æ —Ñ–ª–∞–≥–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ö IFCR (L –∏ H)
		volatile uint32_t *ifcr_tx = (stream > 3) ? &(dma_x->HIFCR) : &(dma_x->LIFCR);
		//—Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π tx
		*ifcr_tx = 0x3F<<shift[stream];
		//—Ä–∞–∑—Ä–µ—à–∞–µ–º spi –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç DMA
		spi->CR2 |= SPI_CR2_TXDMAEN;
		//–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å–∞, –¥–ª–∏–Ω—É, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã
		dma_TX->PAR = (uint32_t)(&spi->DR); //–ø—Ä–∏–µ–º–Ω–∏–∫ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è - –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞ DR spi
		dma_TX->M0AR = (uint32_t)data; //–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–∞–º—è—Ç—å - –∞–¥—Ä–µ—Å –±—É—Ñ–µ—Ä–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
		dma_TX->CR &= ~DMA_SxCR_PINC; //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω
		dma_TX->CR |= DMA_SxCR_MINC;  //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–∞–º—è—Ç–∏ –≤–∫–ª—é—á–µ–Ω
		if (len <= 65535) {
			dma_TX->NDTR = (uint32_t)len; //—Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
			lcd->size_mem = 0;
		}
		else {
			dma_TX->NDTR = 65535;
			lcd->size_mem = len - 65535;
		}
		dma_TX->CR |= (DMA_SxCR_EN); //–≤–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥–∞—á–∏ (—Å—Ç–∞—Ä—Ç DMA –ø–µ—Ä–µ–¥–∞—á–∏)
		return;
	}
	LCD_WriteData(lcd, data, len);
}

void LCD_FillWindow(LCD_Handler* lcd, uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2, uint32_t color)
{
	uint16_t tmp;
	if (x1 > x2) { tmp = x1; x1 = x2; x2 = tmp; }
	if (y1 > y2) { tmp = y1; y1 = y2; y2 = tmp; }
	if (x1 > lcd->Width - 1 || y1 > lcd->Height - 1) return;
	if (x2 > lcd->Width - 1)  x2 = lcd->Width - 1;
	if (y2 > lcd->Height - 1) y2 = lcd->Height - 1;
	uint32_t len = (x2 - x1 + 1) * (y2 - y1 + 1); //–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
	LCD_SetActiveWindow(lcd, x1, y1, x2, y2);
	if (!lcd->cs_control) LCD_CS_LOW
	if (!lcd->dc_control) LCD_DC_HI
	uint16_t color16 = lcd->fill_color = LCD_Color_24b_to_16b(lcd, color);
	SPI_TypeDef *spi = lcd->spi_data.spi;
	spi->CR1 &= ~ (SPI_CR1_BIDIMODE |  	//–∑–¥–µ—Å—å –∑–∞–¥–∞–µ–º —Ä–µ–∂–∏–º
				   SPI_CR1_RXONLY |   	//  Transmit only
				   SPI_CR1_CRCEN | 		//–≤—ã–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç CRC
				   SPI_CR1_DFF); 		//8-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
	if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
		spi->CR1 |= SPI_CR1_DFF; //16-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
	}
	spi->CR1 |= SPI_CR1_SPE; // SPI –≤–∫–ª—é—á–∞–µ–º
	if (lcd->spi_data.dma_tx.dma)
	{
		if (lcd->data_bus == LCD_DATA_8BIT_BUS)	{
			len *= 2;
		}
		DMA_TypeDef *dma_x = lcd->spi_data.dma_tx.dma;
		uint32_t stream = lcd->spi_data.dma_tx.stream;
		DMA_Stream_TypeDef *dma_TX = ((DMA_Stream_TypeDef *)((uint32_t)((uint32_t)dma_x + STREAM_OFFSET_TAB[stream])));
		uint8_t shift[8] = {0, 6, 16, 22, 0, 6, 16, 22}; //–±–∏—Ç–æ–≤–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤–æ —Ñ–ª–∞–≥–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ö IFCR (L –∏ H)
		volatile uint32_t *ifcr_tx = (stream > 3) ? &(dma_x->HIFCR) : &(dma_x->LIFCR);
		//—Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π tx
		*ifcr_tx = 0x3F<<shift[stream];
		//—Ä–∞–∑—Ä–µ—à–∞–µ–º spi –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ DMA
		spi->CR2 |= SPI_CR2_TXDMAEN;
		//–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å–∞, –¥–ª–∏–Ω—É, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã
		dma_TX->PAR = (uint32_t)(&spi->DR); //–ø—Ä–∏–µ–º–Ω–∏–∫ –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è - –∞–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞ DR spi
		dma_TX->M0AR = (uint32_t)&lcd->fill_color; //–∏—Å—Ç–æ—á–Ω–∏–∫ –ø–∞–º—è—Ç—å - –∞–¥—Ä–µ—Å –±—É—Ñ–µ—Ä–∞ –∏—Å—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
		dma_TX->CR &= ~DMA_SxCR_PINC; //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω
		dma_TX->CR &= ~DMA_SxCR_MINC; //–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–∞–º—è—Ç–∏ –æ—Ç–∫–ª—é—á–µ–Ω
		if (len <= 65535) {
			dma_TX->NDTR = (uint32_t)len; //—Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
			lcd->size_mem = 0;
		}
		else {
			dma_TX->NDTR = 65535;
			lcd->size_mem = len - 65535;
		}
		dma_TX->CR |= (DMA_SxCR_EN); // Iniciar DMA

		// üü¢ ESPERA A QUE DMA TERMINE
		while (dma_TX->NDTR > 0);                 // Espera que termine transferencia
		while (spi->SR & SPI_SR_BSY);             // Espera que SPI finalice

		// üü¢ FINALIZA LA TRANSFERENCIA
		spi->CR2 &= ~SPI_CR2_TXDMAEN;             // Desactiva solicitud DMA del SPI
		dma_TX->CR &= ~DMA_SxCR_EN;               // Desactiva canal DMA

		if (!lcd->cs_control) LCD_CS_HI
		spi->CR1 &= ~SPI_CR1_SPE;                 // Apaga SPI

		return;
	}
	if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
		while(len--) {
			LL_SPI_TransmitData16(spi, color16); //–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–≥–∏—Å—Ç—Ä
			while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
		}
	}
	else {
		uint8_t color1 = color16 & 0xFF, color2 = color16 >> 8;
		while(len--) {
			LL_SPI_TransmitData8(spi, color1);
			while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
			LL_SPI_TransmitData8(spi, color2);
			while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
			len--;
		}
	}
	while (spi->SR & SPI_SR_BSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ SPI –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
	if (!lcd->cs_control) LCD_CS_HI
	//–≤—ã–∫–ª—é—á–∞–µ–º spi
	spi->CR1 &= ~SPI_CR1_SPE;
}

/* –ó–∞–∫—Ä–∞—à–∏–≤–∞–µ—Ç –≤–µ—Å—å –¥–∏—Å–ø–ª–µ–π –∑–∞–¥–∞–Ω–Ω—ã–º —Ü–≤–µ—Ç–æ–º */
void LCD_Fill(LCD_Handler* lcd, uint32_t color)
{
	LCD_FillWindow(lcd, 0, 0, lcd->Width - 1, lcd->Height - 1, color);
}

/* –†–∏—Å—É–µ—Ç —Ç–æ—á–∫—É –≤ –∑–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö */
void LCD_DrawPixel(LCD_Handler* lcd, int16_t x, int16_t y, uint32_t color)
{
	if (x > lcd->Width - 1 || y > lcd->Height - 1 || x < 0 || y < 0)	return;
	LCD_SetActiveWindow(lcd, x, y, x, y);
	uint16_t color1 = LCD_Color_24b_to_16b(lcd, color);
	LCD_WriteData(lcd, &color1, 1);
}

/*
 * –†–∏—Å—É–µ—Ç –ª–∏–Ω–∏—é –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –¥–≤—É—Ö —Ç–æ—á–µ–∫
 * –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Ä–∏—Å—É—é—Ç—Å—è –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
 */
void LCD_DrawLine(LCD_Handler* lcd, int16_t x0, int16_t y0, int16_t x1, int16_t y1, uint32_t color)
{
	if(x0 == x1 || y0 == y1) {
		int16_t tmp;
		if (x0 > x1) { tmp = x0; x0 = x1; x1 = tmp; }
		if (y0 > y1) { tmp = y0; y0 = y1; y1 = tmp; }
		if (x1 < 0 || x0 > lcd->Width - 1)  return;
		if (y1 < 0 || y0 > lcd->Height - 1) return;
		if (x0 < 0) x0 = 0;
		if (y0 < 0) y0 = 0;
		LCD_FillWindow(lcd, x0, y0, x1, y1, color);
		return;
	}
	int16_t swap;
    uint16_t steep = ABS(y1 - y0) > ABS(x1 - x0);
    if (steep) {
		swap = x0;
		x0 = y0;
		y0 = swap;

		swap = x1;
		x1 = y1;
		y1 = swap;
    }

    if (x0 > x1) {
		swap = x0;
		x0 = x1;
		x1 = swap;

		swap = y0;
		y0 = y1;
		y1 = swap;
    }

    int16_t dx, dy;
    dx = x1 - x0;
    dy = ABS(y1 - y0);

    int16_t err = dx / 2;
    int16_t ystep;

    if (y0 < y1) {
        ystep = 1;
    } else {
        ystep = -1;
    }

    for (; x0<=x1; x0++) {
        if (steep) {
            LCD_DrawPixel(lcd, y0, x0, color);
        } else {
            LCD_DrawPixel(lcd, x0, y0, color);
        }
        err -= dy;
        if (err < 0) {
            y0 += ystep;
            err += dx;
        }
    }
}

/* –†–∏—Å—É–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ —É–≥–ª–æ–≤ */
void LCD_DrawRectangle(LCD_Handler* lcd, int16_t x1, int16_t y1, int16_t x2, int16_t y2, uint32_t color)
{
	LCD_DrawLine(lcd, x1, y1, x2, y1, color);
	LCD_DrawLine(lcd, x1, y1, x1, y2, color);
	LCD_DrawLine(lcd, x1, y2, x2, y2, color);
	LCD_DrawLine(lcd, x2, y1, x2, y2, color);
}

/* –†–∏—Å—É–µ—Ç –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ —É–≥–ª–æ–≤ */
void LCD_DrawFilledRectangle(LCD_Handler* lcd, int16_t x1, int16_t y1, int16_t x2, int16_t y2, uint32_t color)
{
	int16_t tmp;
	if (x1 > x2) { tmp = x1; x1 = x2; x2 = tmp; }
	if (y1 > y2) { tmp = y1; y1 = y2; y2 = tmp; }
	if (x2 < 0 || x1 > lcd->Width - 1)  return;
	if (y2 < 0 || y1 > lcd->Height - 1) return;
	if (x1 < 0) x1 = 0;
	if (y1 < 0) y1 = 0;
	LCD_FillWindow(lcd, x1, y1, x2, y2, color);
}

/* –†–∏—Å—É–µ—Ç —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º —Ç—Ä–µ—Ö —Ç–æ—á–µ–∫ */
void LCD_DrawTriangle(LCD_Handler* lcd, int16_t x1, int16_t y1, int16_t x2, int16_t y2, int16_t x3, int16_t y3, uint32_t color)
{
	LCD_DrawLine(lcd, x1, y1, x2, y2, color);
	LCD_DrawLine(lcd, x2, y2, x3, y3, color);
	LCD_DrawLine(lcd, x3, y3, x1, y1, color);
}

/* –í–∏–¥—ã –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –æ—Ç—Ä–µ–∑–∫–æ–≤ */
typedef enum {
	LINES_NO_INTERSECT = 0, //–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è
	LINES_INTERSECT,		//–ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è
	LINES_MATCH				//—Å–æ–≤–ø–∞–¥–∞—é—Ç (–Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è)
} INTERSECTION_TYPES;

/*
 * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∏–¥–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ø–æ –æ—Å–∏ —Ö) –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –æ—Ç—Ä–µ–∑–∫–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (x1,y1)-(x2,y2)
 * —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä—è–º–æ–π y = y0
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ –≤–∏–¥–æ–≤ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Ç–∏–ø–∞ INTERSECTION_TYPES, –∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö x_min, x_max - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
 * –ª–∏–±–æ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è).
 * –í match –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–Ω–∏–π (—Å—á–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ –≤—Å–µ—Ö –Ω—É–∂–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)
 */
static INTERSECTION_TYPES LinesIntersection(int16_t x1, int16_t y1, int16_t x2, int16_t y2, int16_t y0, int16_t *x_min, int16_t *x_max, uint8_t *match)
{
	if (y1 == y2) { //–ß–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π - –æ—Ç—Ä–µ–∑–æ–∫ –ø–∞—Ä–∞–ª–ª–µ–ª–µ–Ω –æ—Å–∏ —Ö
		if (y0 == y1) { //–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
			*x_min = min(x1, x2);
			*x_max = max(x1, x2);
			(*match)++;
			return LINES_MATCH;
		}
		return LINES_NO_INTERSECT;
	}
	if (x1 == x2) { //–ß–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π - –æ—Ç—Ä–µ–∑–æ–∫ –ø–∞—Ä–∞–ª–ª–µ–ª–µ–Ω –æ—Å–∏ y
		if (min(y1, y2) <= y0 && y0 <= max(y1, y2)) {
			*x_min = *x_max = x1;
			return LINES_INTERSECT;
		}
		return LINES_NO_INTERSECT;
	}
	//–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä—è–º—ã—Ö (—É—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä—è–º–æ–π –ø–æ–ª—É—á–∞–µ–º –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç–æ—á–µ–∫, –∑–∞–¥–∞—é—â–∏—Ö –æ—Ç—Ä–µ–∑–æ–∫)
	*x_min = *x_max = (x2 - x1) * (y0 - y1) / (y2 - y1) + x1;
	if (min(x1, x2) <= *x_min && *x_min <= max(x1, x2)) { //–ï—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ x —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ—Ç—Ä–µ–∑–∫—É,
		return LINES_INTERSECT;							  //—Ç–æ –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
	}
	return LINES_NO_INTERSECT;
}

/* –†–∏—Å—É–µ—Ç –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º —Ç—Ä–µ—Ö —Ç–æ—á–µ–∫ */
void LCD_DrawFilledTriangle(LCD_Handler* lcd, int16_t x1, int16_t y1, int16_t x2, int16_t y2, int16_t x3, int16_t y3, uint32_t color)
{
	//–°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è y
	int16_t tmp;
	if (y1 > y2) {
		tmp = y1; y1 = y2; y2 = tmp;
		tmp = x1; x1 = x2; x2 = tmp;
	}
	if (y1 > y3) {
		tmp = y1; y1 = y3; y3 = tmp;
		tmp = x1; x1 = x3; x3 = tmp;
	}
	if (y2 > y3) {
		tmp = y2; y2 = y3; y3 = tmp;
		tmp = x2; x2 = x3; x3 = tmp;
	}
	//–ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤ –æ–±–ª–∞—Å—Ç—å –≤—ã–≤–æ–¥–∞
	if (y1 > lcd->Height - 1 ||	y3 < 0) return;
	int16_t xmin = min3(x1, x2, x3);
	int16_t xmax = max3(x1, x2, x3);
	if (xmax < 0 || xmin > lcd->Width - 1) return;
	uint8_t c_mas, match;
	int16_t x_mas[8], x_min, x_max;
	//"–û–±—Ä–µ–∑–∞–µ–º" –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –≤—ã—Ö–æ–¥—è—â–∏–µ –∑–∞ —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å –¥–∏—Å–ø–ª–µ—è
	int16_t y_start = y1 < 0 ? 0: y1;
	int16_t y_end = y3 > lcd->Height - 1 ? lcd->Height - 1: y3;
	//–ü—Ä–æ—Ö–æ–¥–∏–º –≤ —Ü–∏–∫–ª–µ –ø–æ —Ç–æ—á–∫–∞–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã y –∏ –∏—â–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –æ—Ç—Ä–µ–∑–∫–∞ y = y[i] (–≥–¥–µ y[i]=y1...y3, 1)
	//—Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
	for (int16_t y = y_start; y < y_end; y++) {
		c_mas = match = 0;
		if (LinesIntersection(x1, y1, x2, y2, y, &x_mas[c_mas], &x_mas[c_mas + 1], &match)) {
			c_mas += 2;
		}
		if (LinesIntersection(x2, y2, x3, y3, y, &x_mas[c_mas], &x_mas[c_mas + 1], &match)) {
			c_mas += 2;
		}
		if (LinesIntersection(x3, y3, x1, y1, y, &x_mas[c_mas], &x_mas[c_mas + 1], &match)) {
			c_mas += 2;
		}
		if (!c_mas) continue;
		x_min = x_max = x_mas[0];
		while (c_mas) {
			x_min = min(x_min, x_mas[c_mas - 2]);
			x_max = max(x_max, x_mas[c_mas - 1]);
			c_mas -= 2;
		}
		LCD_DrawLine(lcd, x_min, y, x_max, y, color);
	}
}

/* –†–∏—Å—É–µ—Ç –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º –∏ —Ä–∞–¥–∏—É—Å–æ–º */
void LCD_DrawCircle(LCD_Handler* lcd, int16_t x0, int16_t y0, int16_t r, uint32_t color)
{
	int16_t f = 1 - r;
	int16_t ddF_x = 1;
	int16_t ddF_y = -2 * r;
	int16_t x = 0;
	int16_t y = r;

	LCD_DrawPixel(lcd, x0, y0 + r, color);
	LCD_DrawPixel(lcd, x0, y0 - r, color);
	LCD_DrawPixel(lcd, x0 + r, y0, color);
	LCD_DrawPixel(lcd, x0 - r, y0, color);

	while (x < y) {
		if (f >= 0) {
			y--;
			ddF_y += 2;
			f += ddF_y;
		}
		x++;
		ddF_x += 2;
		f += ddF_x;

		LCD_DrawPixel(lcd, x0 + x, y0 + y, color);
		LCD_DrawPixel(lcd, x0 - x, y0 + y, color);
		LCD_DrawPixel(lcd, x0 + x, y0 - y, color);
		LCD_DrawPixel(lcd, x0 - x, y0 - y, color);

		LCD_DrawPixel(lcd, x0 + y, y0 + x, color);
		LCD_DrawPixel(lcd, x0 - y, y0 + x, color);
		LCD_DrawPixel(lcd, x0 + y, y0 - x, color);
		LCD_DrawPixel(lcd, x0 - y, y0 - x, color);
	}
}

/* –†–∏—Å—É–µ—Ç –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º –∏ —Ä–∞–¥–∏—É—Å–æ–º */
void LCD_DrawFilledCircle(LCD_Handler* lcd, int16_t x0, int16_t y0, int16_t r, uint32_t color)
{
	int16_t f = 1 - r;
	int16_t ddF_x = 1;
	int16_t ddF_y = -2 * r;
	int16_t x = 0;
	int16_t y = r;

	LCD_DrawLine(lcd, x0 - r, y0, x0 + r, y0, color);

	while (x < y) {
		if (f >= 0)	{
			y--;
			ddF_y += 2;
			f += ddF_y;
		}
		x++;
		ddF_x += 2;
		f += ddF_x;

		LCD_DrawLine(lcd, x0 - x, y0 + y, x0 + x, y0 + y, color);
		LCD_DrawLine(lcd, x0 + x, y0 - y, x0 - x, y0 - y, color);

		LCD_DrawLine(lcd, x0 + y, y0 + x, x0 - y, y0 + x, color);
		LCD_DrawLine(lcd, x0 + y, y0 - x, x0 - y, y0 - x, color);
	}
}

/*
 * –í—ã–≤–æ–¥–∏—Ç –≤ –∑–∞–¥–∞–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–∏—Å–ø–ª–µ—è –±–ª–æ–∫ –ø–∞–º—è—Ç–∏ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) –ø–æ –∞–¥—Ä–µ—Å—É –≤ data:
 * x, y - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –æ–±–ª–∞—Å—Ç–∏ –¥–∏—Å–ø–ª–µ—è;
 * w, h - —à–∏—Ä–∏–Ω–∞ –∏ –≤—ã—Å–æ—Ç–∞ –æ–±–ª–∞—Å—Ç–∏ –¥–∏—Å–ø–ª–µ—è;
 * data - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –±–ª–æ–∫ –ø–∞–º—è—Ç–∏ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–∞ –¥–∏—Å–ø–ª–µ–π;
 * dma_use_flag - —Ñ–ª–∞–≥, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∏–µ DMA (0 - –±–µ–∑ DMA, !=0 - —Å DMA)
 */
void LCD_DrawImage(LCD_Handler* lcd, uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t *data, uint8_t dma_use_flag)
{
	if ((x >= lcd->Width) || (y >= lcd->Height) || (x + w - 1) >= lcd->Width || (y + h - 1) >= lcd->Height) return;
	LCD_SetActiveWindow(lcd, x, y, x + w - 1, y + h - 1);
	if (dma_use_flag) {
		LCD_WriteDataDMA(lcd, data, w * h);
	}
	else {
		LCD_WriteData(lcd, data, w * h);
	}
}

/* –ß–∏—Ç–∞–µ—Ç –≤ –±—É—Ñ–µ—Ä data –¥–∞–Ω–Ω—ã–µ –æ —Ü–≤–µ—Ç–µ –ø–∏–∫—Å–µ–ª–µ–π –∏–∑ –æ–∫–Ω–∞ –¥–∏—Å–ø–ª–µ—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ (x, y), —à–∏—Ä–∏–Ω–æ–π w, –≤—ã—Å–æ—Ç–æ–π h.
* –î–æ—Å—Ç—É–ø–Ω—ã 2 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã —Å–æ spi: –ø–æ–ª–Ω—ã–π –¥—É–ø–ª–µ–∫—Å (full-duplex) –∏ –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å (half-duplex).
* –ü–æ–ª–Ω—ã–π –¥—É–ø–ª–µ–∫—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–ø–ª–µ—è—Ö, –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã—Ö –∫ –ú–ö –ø–æ –¥–≤—É–º –æ–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –ª–∏–Ω–∏—è–º –¥–∞–Ω–Ω—ã—Ö: MOSI –∏ MISO.
* –ü–æ–ª—É–¥—É–ø–ª–µ–∫—Å –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –¥–∏—Å–ø–ª–µ–µ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤—ã–≤–æ–¥ SDA, —Å–æ–≤–º–µ—â–∞—é—â–∏–π –ª–∏–Ω–∏–∏
* in/out. –í—ã–≤–æ–¥ CS –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–∞ –°–¢–†–û–ì–û –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù, —Ç.–∫. —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —ç—Ç–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
* –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–∏—Å–ø–ª–µ—è –≤—ã–π–¥–µ—Ç –∏–∑ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö MCU –∏ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –æ—Ç MCU. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏
* –≤—ã–≤–æ–¥–∞ CS –≤–æ–∑–≤—Ä–∞—Ç –≤ —Ä–µ–∂–∏–º –ø—Ä–∏–µ–º–∞ –∫–æ–º–∞–Ω–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º –¥–∏—Å–ø–ª–µ—è –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ (reset)
* –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è, –∫–æ—Ç–æ—Ä—ã–π –≤ –¥–∞–Ω–Ω–æ–º –¥—Ä–∞–π–≤–µ—Ä–µ/–±–∏–±–ª–∏–æ—Ç–µ–∫–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LCD_Init(lcd),
* –≥–¥–µ lcd - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏—Å–ø–ª–µ—è.
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–º —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º SPI_HALF_DUPLEX_READ –≤ —Ñ–∞–π–ª–µ display.h.
* –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–∞:
* #define SPI_HALF_DUPLEX_READ	1
* –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –¥—É–ø–ª–µ–∫—Å–∞:
* #define SPI_HALF_DUPLEX_READ	0
* –°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –Ω–∏–∂–µ (–∏–Ω–æ–≥–¥–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ) —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ—ç—Ç–æ–º—É –≤–≤–µ–¥–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä,
* –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è SPI_SPEED_DISPLAY_READ. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 7 –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è
* –≤ display.h. –ü—Ä–∏—á–µ–º, 0 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç clk/2, 1 - clk/4, ... 7 - clk/256. –ì–¥–µ clk - —á–∞—Å—Ç–æ—Ç–∞ —Ç–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è spi.
*/
void LCD_ReadImage(LCD_Handler* lcd, uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t *data)
{
	uint16_t x1 = x + w - 1, y1 = y + h - 1; //–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ —É–≥–ª–∞ –æ–∫–Ω–∞
	//–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–∫–Ω–∞, —Ç.–∫. –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ –¥–∏—Å–ø–ª–µ—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ–º
	if (x >= lcd->Width || y >= lcd->Height || x1 >= lcd->Width || y1 >= lcd->Height) return;
	//–ü–µ—Ä–µ—Å—á–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ–∫–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –º–∞—Ç—Ä–∏—Ü—ã –¥–∏—Å–ø–ª–µ—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.
	//–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π offs –≤ –¥—Ä–∞–π–≤–µ—Ä–µ –¥–∏—Å–ø–ª–µ—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —É—á–∏—Ç—ã–≤–∞—è —Ä–∞–∑–Ω–∏—Ü—É —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–µ–π,
	//–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –¥–∏—Å–ø–ª–µ—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—è –ø–∞–º—è—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –º–∞—Ç—Ä–∏—Ü–µ
	x += lcd->x_offs;
	y += lcd->y_offs;
	x1 += lcd->x_offs;
	y1 += lcd->y_offs;
	//–°–æ–∑–¥–∞–µ–º —É–ø—Ä–∞–≤–ª—è—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ –¥—Ä–∞–π–≤–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∂–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É –¥–∏—Å–ø–ª–µ—è,
	//—á—Ç–æ –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ –∏ —Ö–æ—Ç–∏–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç—É –æ–±–ª–∞—Å—Ç—å. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–º –¥–∏—Å–ø–ª–µ–π –≤
	//—Ä–µ–∂–∏–º —Ü–≤–µ—Ç–∞ 18 –±–∏—Ç, —Ç–∞–∫ –∫–∞–∫ –∫–æ–º–∞–Ω–¥–∞ Memory Read (0x2E) –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∂–∏–º–æ–º —Ü–≤–µ—Ç–∞ 18 –±–∏—Ç.
	uint8_t	set_win_and_read[] = { //–ö–æ–º–∞–Ω–¥–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —Ü–≤–µ—Ç–∞
								   LCD_UPR_COMMAND, 0x3A, 1, 0x66, //0x66 - 18-–±–∏—Ç–Ω—ã–π —Ü–≤–µ—Ç, 0x55 - 16-–±–∏—Ç–Ω—ã–π
								   //–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–¥—Ä–µ—Å–æ–≤, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏—Ö –±–ª–æ–∫:
								   LCD_UPR_COMMAND, 0x2A, 4, 0, 0, 0, 0, //—Å—Ç–æ–ª–±–µ—Ü
								   LCD_UPR_COMMAND, 0x2B, 4, 0, 0, 0, 0, //—Å—Ç—Ä–æ–∫–∞
								   //–ö–æ–º–∞–Ω–¥–∞ Memory Read (—á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å)
								   LCD_UPR_COMMAND, 0x2E, 0,
								   LCD_UPR_END	};
	//–í–ø–∏—Å—ã–≤–∞–µ–º –≤ —É–ø—Ä–∞–≤–ª—è—é—â—É—é —Å—Ç—Ä–æ–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
	set_win_and_read[7]  = x >> 8;  set_win_and_read[8]  = x & 0xFF;
	set_win_and_read[9]  = x1 >> 8; set_win_and_read[10]  = x1 & 0xFF;
	set_win_and_read[14] = y >> 8;  set_win_and_read[15] = y & 0xFF;
	set_win_and_read[16] = y1 >> 8; set_win_and_read[17] = y1 & 0xFF;
	//–ñ–¥–µ–º, –∫–æ–≥–¥–∞ –¥–∏—Å–ø–ª–µ–π –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –∏ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –¥–∞–Ω–Ω—ã—Ö
	while (LCD_GetState(lcd) != LCD_STATE_READY) ;
	lcd->cs_control = 1; //–û—Ç–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–µ–π CS —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö —Å—Ç—Ä–æ–∫
	SPI_TypeDef *spi = lcd->spi_data.spi;
	uint32_t spi_param = spi->CR1; //–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã spi
	//–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º spi (spi —É –Ω–∞—Å —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω)
	//–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª–Ω—ã–π –¥—É–ø–ª–µ–∫—Å
	spi->CR1 &= ~(SPI_CR1_BIDIMODE |  //2 –ª–∏–Ω–∏–∏, –æ–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
				  SPI_CR1_RXONLY   |  //–ø—Ä–∏–µ–º –∏ –ø–µ—Ä–µ–¥–∞—á–∞
				  SPI_CR1_CRCEN    |
				  SPI_CR1_BR_Msk   |  //–ú–∞—Å–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ spi
				  SPI_CR1_DFF); 	  //–®–∏—Ä–∏–Ω–∞ –∫–∞–¥—Ä–∞ 8 –±–∏—Ç
	//–£—Å—Ç–∞–Ω–æ–≤–∏–º —Å–∫–æ—Ä–æ—Å—Ç—å spi –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∏—Å–ø–ª–µ—è.
	//–ü–∞—Ä–∞–º–µ—Ç—Ä SPI_SPEED_DISPLAY_READ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ display.h
	//–î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –¥–∏—Å–ø–ª–µ—è, —Å–∫–æ—Ä–æ—Å—Ç—å
	//–≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –Ω–∏–∂–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤ —Ä–µ–∂–∏–º–µ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
	//–≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
	spi->CR1 |= (uint32_t)((SPI_SPEED_DISPLAY_READ & 7) << SPI_CR1_BR_Pos);
	//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä —É–ø—Ä–∞–≤–ª—è—é—â—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–∏—Å–ø–ª–µ—è
	//"–î–µ—Ä–≥–∞—Ç—å" –≤—ã–≤–æ–¥–æ–º CS –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã 0x2E –Ω–µ–ª—å–∑—è, —Ç.–∫. –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
	//–¥–∏—Å–ø–ª–µ—è –º–æ–∂–µ—Ç "–ø–æ–¥—É–º–∞—Ç—å", —á—Ç–æ –º—ã —Ö–æ—Ç–∏–º –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —á—Ç–µ–Ω–∏–µ.
	LCD_CS_LOW //–ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–∏—Å–ø–ª–µ—è –∫ –ú–ö
	LCD_String_Interpretator(lcd, set_win_and_read);
	LCD_DC_HI //–í—ã–≤–æ–¥ DC –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è —É—Å—Ç–∞–Ω–æ–≤–∏–º –≤ –ø–æ–ª–æ–∂–µ–Ω–∏–∏ "–¥–∞–Ω–Ω—ã–µ". –ù–æ, –º–æ–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç,
	//—á—Ç–æ —á—Ç–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ –ø–æ–ª–æ–∂–µ–Ω–∏–∏ "–∫–æ–º–∞–Ω–¥–∞", —á—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ, —Ç.–∫. —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞, –≤ —Ç.—á.,
	//NOP –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é —á—Ç–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞. –í –æ–±—â–µ–º, —á—Ç–µ–Ω–∏–µ –∏–¥–µ—Ç –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –º—ã –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–µ–º
	//–≤—Å—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–∞–º–∏ –æ–±–ª–∞—Å—Ç—å, –ª–∏–±–æ –ø–æ–∫–∞ —Ç—É–ø–æ –Ω–µ –ø—Ä–µ—Ä–≤–µ–º –ø—Ä–æ—Ü–µ—Å—Å —á—Ç–µ–Ω–∏—è.
	uint32_t len = w * h; //–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–∫—Å–µ–ª–µ–π –¥–ª—è —á—Ç–µ–Ω–∏—è
	uint16_t *data_ptr = data; //–£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∏–∫—Å–µ–ª–µ–π
	uint8_t r, g, b; //–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å —Ü–≤–µ—Ç–æ–≤—ã–º–∏ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–º–∏
#if (SPI_HALF_DUPLEX_READ == 1) //–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å, —Ç–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ spi
	//–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏–µ–º):
	spi->CR1 |= SPI_CR1_BIDIMODE; //–î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
	spi->CR1 &= ~SPI_CR1_BIDIOE;  //–†–µ–∂–∏–º –ø—Ä–∏–µ–º–∞
	spi->CR1 ^= SPI_CR1_CPHA_Msk; //–°–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –º–µ–Ω—è–µ–º —Ñ–∞–∑—É –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é (–¥–ª—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–∞)
#endif
	//–í–∫–ª—é—á–∞–µ–º spi. –î–ª—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏–µ–º —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å—Ä–∞–∑—É –∂–µ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∏–º spi (–ø–æ–π–¥—É—Ç —Ç–∞–∫—Ç—ã –æ—Ç MCU)
	spi->CR1 |= SPI_CR1_SPE;
	//16 —Ö–æ–ª–æ—Å—Ç—ã—Ö —Ç–∞–∫—Ç–æ–≤ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö MCU
	int i = 2;
	while (i--) {
#if (SPI_HALF_DUPLEX_READ == 0) //–í –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–µ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –∑–∞–ª–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ DR –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ç–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–¥–æ
		LL_SPI_TransmitData8(spi, 0x00); //NOP
#endif
		while (!(spi->SR & SPI_SR_RXNE)) ; //–û–∂–∏–¥–∞–µ–º –ø—Ä–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è
		r = LL_SPI_ReceiveData8(spi);
	}
	//------------------------------ –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ü–≤–µ—Ç–µ len –ø–∏–∫—Å–µ–ª–µ–π --------------------------
	while (len--) {
		//–°—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Ü–≤–µ—Ç–æ–≤—ã–µ —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–µ
		//–ü–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—á–∏—Ç—ã–≤–∞–µ–º—ã—Ö —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏—Ö —Ü–≤–µ—Ç–æ–≤ –∑–∞—è–≤–ª–µ–Ω–∞ r, g, b,
		//–ï—Å–ª–∏ —Å—á–∏—Ç—ã–≤–∞–µ–º—ã–µ —Ü–≤–µ—Ç–∞ –±—É–¥—É—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º, —Ç–æ —Å–Ω–∏–∑—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å spi –¥–ª—è —á—Ç–µ–Ω–∏—è,
		//–Ω–æ –∏–Ω–æ–≥–¥–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —á—Ç–µ–Ω–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥—Ç—è–∂–∫–∞ –∫ –ø–∏—Ç–∞–Ω–∏—é –ª–∏–Ω–∏–∏ MISO spi.
#if (SPI_HALF_DUPLEX_READ == 0)
		LL_SPI_TransmitData8(spi, 0x00); //NOP
#endif
		while (!(spi->SR & SPI_SR_RXNE)) ;//–û–∂–∏–¥–∞–µ–º –ø—Ä–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–∏—Å–ø–ª–µ—è
		r = LL_SPI_ReceiveData8(spi);
#if (SPI_HALF_DUPLEX_READ == 0)
		LL_SPI_TransmitData8(spi, 0x00); //NOP
#endif
		while (!(spi->SR & SPI_SR_RXNE)) ;
		g = LL_SPI_ReceiveData8(spi);
#if (SPI_HALF_DUPLEX_READ == 0)
		LL_SPI_TransmitData8(spi, 0x00); //NOP
#endif
		while (!(spi->SR & SPI_SR_RXNE)) ;
		b = LL_SPI_ReceiveData8(spi);
		*data_ptr++ = LCD_Color(lcd, r, g, b); //–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ R8G8B8 –≤ R5G6B5 –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ
	}
	LCD_CS_HI //–û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–∏—Å–ø–ª–µ—è –æ—Ç –ú–ö.
	  	  	  //–í —Ä–µ–∂–∏–º–µ –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–∞, —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, —ç—Ç–æ –±—É–¥–µ—Ç –µ—â–µ –∏ —Å–∏–≥–Ω–∞–ª–æ–º –¥–ª—è
	  	  	  //–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–Ω–∏–∏ SDA –Ω–∞ –ø—Ä–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç MCU. –¢–∞–∫ —á—Ç–æ, –±–µ–∑
	  	  	  //–ª–∏–Ω–∏–∏ CS –Ω–∞ –¥–∏—Å–ø–ª–µ–µ –ù–ï –û–ë–û–ô–¢–ò–°–¨.
#if (SPI_HALF_DUPLEX_READ == 0)
	while (spi->SR & SPI_SR_BSY) ; //–ñ–¥–µ–º –∫–æ–≥–¥–∞ spi –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
											  //–ê –≤ –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–µ –∂–¥–∞—Ç—å –Ω–µ –Ω–∞–¥–æ (—Å–º. —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é MCU),
											  //–Ω–æ –Ω–∞–¥–æ –¥–æ—á–∏—Ç—ã–≤–∞—Ç—å...
#endif
	spi->CR1 &= ~SPI_CR1_SPE; //spi –≤—ã–∫–ª—é—á–∞–µ–º
#if (SPI_HALF_DUPLEX_READ == 1)
	//–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –¥–æ—á–∏—Ç—ã–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è spi –¥–ª—è –ø–æ–ª—É–¥—É–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç "–Ω–µ –≥—É–¥"
	while (!(spi->SR & SPI_SR_RXNE)) ;
#endif
	spi->CR1 = spi_param; //–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã spi
	//–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 16-–±–∏—Ç–Ω—ã–π —Ä–µ–∂–∏–º —Ü–≤–µ—Ç–∞
	lcd->cs_control = 0; //–í–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–µ–π CS —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö —Å—Ç—Ä–æ–∫
	uint8_t	color_restore[]  = { LCD_UPR_COMMAND, 0x3A, 1, 0x55,
								 LCD_UPR_END };
	LCD_String_Interpretator(lcd, color_restore);
}

/*
 * –í—ã–≤–æ–¥ –Ω–∞ –¥–∏—Å–ø–ª–µ–π —Å–∏–º–≤–æ–ª–∞ —Å –∫–æ–¥–æ–º –≤ ch, —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (x, y), —à—Ä–∏—Ñ—Ç–æ–º font, —Ü–≤–µ—Ç–æ–º color,
 * —Ü–≤–µ—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏—è bgcolor.
 * modesym - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –≤—ã–≤–æ–¥–∏—Ç—å —Å–∏–º–≤–æ–ª:
 *    LCD_SYMBOL_PRINT_FAST - –±—ã—Å—Ç—Ä—ã–π –≤—ã–≤–æ–¥ —Å –ø–æ–ª–Ω—ã–º –∑–∞—Ç–∏—Ä–∞–Ω–∏–µ–º –∑–Ω–∞–∫–æ–º–µ—Å—Ç–∞;
 *    LCD_SYMBOL_PRINT_PSETBYPSET - –≤—ã–≤–æ–¥ —Å–∏–º–≤–æ–ª–∞ –ø–æ —Ç–æ—á–∫–∞–º, –ø—Ä–∏ —ç—Ç–æ–º —Ü–≤–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è bgcolor –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (—Ä–µ–∂–∏–º –Ω–∞–ª–æ–∂–µ–Ω–∏—è).
 * –®–∏—Ä–∏–Ω–∞ —Å–∏–º–≤–æ–ª–∞ –¥–æ 32 –ø–∏–∫—Å–µ–ª–µ–π (4 –±–∞–π—Ç–∞ –Ω–∞ —Å—Ç—Ä–æ–∫—É). –í—ã—Å–æ—Ç–∞ —Å–∏–º–≤–æ–ª–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è.
 */
void LCD_WriteChar(LCD_Handler* lcd, uint16_t x, uint16_t y, char ch, FontDef *font, uint32_t txcolor, uint32_t bgcolor, LCD_PrintSymbolMode modesym)
{
	int i, j, k;
	uint32_t tmp = 0;
	const uint8_t *b = font->data;
	uint16_t color;
	uint16_t txcolor16 = LCD_Color_24b_to_16b(lcd, txcolor);
	uint16_t bgcolor16 = LCD_Color_24b_to_16b(lcd, bgcolor);
	ch = ch < font->firstcode || ch > font->lastcode ? 0: ch - font->firstcode;
	int bytes_per_line = ((font->width - 1) >> 3) + 1;
	if (bytes_per_line > 4) { //–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —à–∏—Ä–∏–Ω—ã —Å–∏–º–≤–æ–ª–æ–≤ –¥–æ 32 –ø–∏–∫—Å–µ–ª–µ–π (4 –±–∞–π—Ç–∞ –Ω–∞ —Å—Ç—Ä–æ–∫—É)
		return;
	}
	k = 1 << ((bytes_per_line << 3) - 1);
	b += ch * bytes_per_line * font->height;
	SPI_TypeDef *spi = lcd->spi_data.spi;
	if (modesym == LCD_SYMBOL_PRINT_FAST) {
		LCD_SetActiveWindow(lcd, x, y, x + font->width - 1, y + font->height - 1);
		LCD_CS_LOW
		LCD_DC_HI
		spi->CR1 &= ~SPI_CR1_SPE; // SPI –≤—ã–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
		spi->CR1 &= ~ (SPI_CR1_BIDIMODE |  	//–∑–¥–µ—Å—å –∑–∞–¥–∞–µ–º —Ä–µ–∂–∏–º
					   SPI_CR1_RXONLY |   	//  Transmit only
					   SPI_CR1_CRCEN | 		//–≤—ã–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç CRC
					   SPI_CR1_DFF); 		//8-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
		if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
			spi->CR1 |= SPI_CR1_DFF; //16-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
		}
		spi->CR1 |= SPI_CR1_SPE; // SPI –≤–∫–ª—é—á–∞–µ–º
		for (i = 0; i < font->height; i++) {
			if (bytes_per_line == 1)      { tmp = *((uint8_t*)b);  }
			else if (bytes_per_line == 2) { tmp = *((uint16_t*)b); }
			else if (bytes_per_line == 3) { tmp = (*((uint8_t*)b)) | ((*((uint8_t*)(b + 1))) << 8) |  ((*((uint8_t*)(b + 2))) << 16); }
			else { tmp = *((uint32_t*)b); }
			b += bytes_per_line;
			for (j = 0; j < font->width; j++)
			{
				color = (tmp << j) & k ? txcolor16: bgcolor16;
				while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
				if (lcd->data_bus == LCD_DATA_16BIT_BUS) {
					LL_SPI_TransmitData16(spi, color);
				}
				else {
					uint8_t color1 = color & 0xFF, color2 = color >> 8;
					LL_SPI_TransmitData8(spi, color1);
					while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
					LL_SPI_TransmitData8(spi, color2);
				}
			}
		}
		while (!(spi->SR & SPI_SR_TXE)) ; //–∂–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
		while (spi->SR & SPI_SR_BSY) ; //–∂–¥–µ–º –∫–æ–≥–¥–∞ SPI –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è
		//–≤—ã–∫–ª—é—á–∞–µ–º spi
		spi->CR1 &= ~SPI_CR1_SPE;
		LCD_CS_HI
	}
	else {
		for (i = 0; i < font->height; i++) {
			if (bytes_per_line == 1) { tmp = *((uint8_t*)b); }
			else if (bytes_per_line == 2) { tmp = *((uint16_t*)b); }
			else if (bytes_per_line == 3) { tmp = (*((uint8_t*)b)) | ((*((uint8_t*)(b + 1))) << 8) |  ((*((uint8_t*)(b + 2))) << 16); }
			else if (bytes_per_line == 4) { tmp = *((uint32_t*)b); }
			b += bytes_per_line;
			for (j = 0; j < font->width; j++) {
				if ((tmp << j) & k) {
					LCD_DrawPixel(lcd, x + j, y + i, txcolor);
				}
			}
		}
	}
}

//–≤—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ str —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–∑–∏—Ü–∏–∏ x, y, —à—Ä–∏—Ñ—Ç–æ–º font, —Ü–≤–µ—Ç–æ–º –±—É–∫–≤ color, —Ü–≤–µ—Ç–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏—è bgcolor
//modesym - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –≤—ã–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç:
//LCD_SYMBOL_PRINT_FAST - –±—ã—Å—Ç—Ä—ã–π –≤—ã–≤–æ–¥ —Å –ø–æ–ª–Ω—ã–º –∑–∞—Ç–∏—Ä–∞–Ω–∏–µ–º –∑–Ω–∞–∫–æ–º–µ—Å—Ç–∞
//LCD_SYMBOL_PRINT_PSETBYPSET - –≤—ã–≤–æ–¥ –ø–æ —Ç–æ—á–∫–∞–º, –ø—Ä–∏ —ç—Ç–æ–º —Ü–≤–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è bgcolor –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å –Ω–∞–¥–ø–∏—Å–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
void LCD_WriteString(LCD_Handler* lcd, uint16_t x, uint16_t y, const char *str, FontDef *font, uint32_t color, uint32_t bgcolor, LCD_PrintSymbolMode modesym)
{
	while (*str) {
		if (x + font->width > lcd->Width) {
			x = 0;
			y += font->height;
			if (y + font->height > lcd->Height) {
				break;
			}
		}
		LCD_WriteChar(lcd, x, y, *str, font, color, bgcolor, modesym);
		x += font->width;
		str++;
	}
	lcd->AtPos.x = x;
	lcd->AtPos.y = y;
}

inline uint16_t LCD_Color (LCD_Handler *lcd, uint8_t r, uint8_t g, uint8_t b)
{
	uint16_t color = (((uint16_t)r & 0xF8) << 8) | (((uint16_t)g & 0xFC) << 3) | (((uint16_t)b >> 3));
	if (lcd->data_bus == LCD_DATA_8BIT_BUS) {//8-–±–∏—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
		color = (color >> 8) | ((color & 0xFF) << 8);
	}
	return color;
}

inline uint16_t LCD_Color_24b_to_16b(LCD_Handler *lcd, uint32_t color)
{
	uint8_t r = (color >> 16) & 0xff;
	uint8_t g = (color >> 8) & 0xff;
	uint8_t b = color & 0xff;
	return LCD_Color(lcd, r, g, b);
}
