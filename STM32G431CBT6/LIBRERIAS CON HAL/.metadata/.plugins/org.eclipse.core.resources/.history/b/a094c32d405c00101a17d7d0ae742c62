
#include "st7789.h"

#ifdef USE_DMA
#include "string.h"
#include "stdio.h"
uint16_t DMA_MIN_SIZE = 16;
#define HOR_LEN 10
uint16_t disp_buf[ST7789_WIDTH * HOR_LEN];
#endif

static void ST7789_WriteCommand(uint8_t cmd)
{
    ST7789_Select();
    ST7789_DC_Clr();
    HAL_SPI_Transmit(&ST7789_SPI_PORT, &cmd, 1, HAL_MAX_DELAY);
    ST7789_UnSelect();
}

static void ST7789_WriteData(uint16_t *buff, size_t buff_size)
{
    ST7789_Select();
    ST7789_DC_Set();

    while (buff_size > 0) {
        uint16_t chunk_size = buff_size > 32767 ? 32767 : buff_size;
#ifdef USE_DMA
        if (DMA_MIN_SIZE <= buff_size) {
            HAL_SPI_Transmit_DMA(&ST7789_SPI_PORT, (uint8_t *)buff, chunk_size * 2);
            while (ST7789_SPI_PORT.hdmatx->State != HAL_DMA_STATE_READY) {}
        } else {
            HAL_SPI_Transmit(&ST7789_SPI_PORT, (uint8_t *)buff, chunk_size * 2, HAL_MAX_DELAY);
        }
#else
        HAL_SPI_Transmit(&ST7789_SPI_PORT, (uint8_t *)buff, chunk_size * 2, HAL_MAX_DELAY);
#endif
        buff += chunk_size;
        buff_size -= chunk_size;
    }

    ST7789_UnSelect();
}

static void ST7789_WriteSmallData(uint8_t data)
{
    ST7789_Select();
    ST7789_DC_Set();
    HAL_SPI_Transmit(&ST7789_SPI_PORT, &data, 1, HAL_MAX_DELAY);
    ST7789_UnSelect();
}

void ST7789_SetRotation(uint8_t m)
{
    ST7789_WriteCommand(ST7789_MADCTL);
    switch (m) {
        case 0:
            ST7789_WriteSmallData(ST7789_MADCTL_MX | ST7789_MADCTL_MY | ST7789_MADCTL_RGB);
            break;
        case 1:
            ST7789_WriteSmallData(ST7789_MADCTL_MY | ST7789_MADCTL_MV | ST7789_MADCTL_RGB);
            break;
        case 2:
            ST7789_WriteSmallData(ST7789_MADCTL_RGB);
            break;
        case 3:
            ST7789_WriteSmallData(ST7789_MADCTL_MX | ST7789_MADCTL_MV | ST7789_MADCTL_RGB);
            break;
        default:
            break;
    }
}

static void ST7789_SetAddressWindow(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1)
{
    ST7789_Select();
    uint16_t x_start = x0 + X_SHIFT, x_end = x1 + X_SHIFT;
    uint16_t y_start = y0 + Y_SHIFT, y_end = y1 + Y_SHIFT;

    ST7789_WriteCommand(ST7789_CASET);
    {
        uint8_t data[] = {x_start >> 8, x_start & 0xFF, x_end >> 8, x_end & 0xFF};
        HAL_SPI_Transmit(&ST7789_SPI_PORT, data, sizeof(data), HAL_MAX_DELAY);
    }

    ST7789_WriteCommand(ST7789_RASET);
    {
        uint8_t data[] = {y_start >> 8, y_start & 0xFF, y_end >> 8, y_end & 0xFF};
        HAL_SPI_Transmit(&ST7789_SPI_PORT, data, sizeof(data), HAL_MAX_DELAY);
    }

    ST7789_WriteCommand(ST7789_RAMWR);
    ST7789_UnSelect();
}

void ST7789_Init(void)
{
#ifdef USE_DMA
    memset(disp_buf, 0, sizeof(disp_buf));
#endif

    ST7789_Select();
    HAL_Delay(10);
    ST7789_RST_Clr();
    HAL_Delay(10);
    ST7789_RST_Set();
    HAL_Delay(20);

    ST7789_WriteCommand(ST7789_COLMOD);
    ST7789_WriteSmallData(ST7789_COLOR_MODE_16bit);
    ST7789_WriteCommand(0xB2);
    {
        uint8_t data[] = {0x0C, 0x0C, 0x00, 0x33, 0x33};
        HAL_SPI_Transmit(&ST7789_SPI_PORT, data, sizeof(data), HAL_MAX_DELAY);
    }

    ST7789_SetRotation(ST7789_ROTATION);
    ST7789_WriteCommand(0xB7);
    ST7789_WriteSmallData(0x35);
    ST7789_WriteCommand(0xBB);
    ST7789_WriteSmallData(0x19);
    ST7789_WriteCommand(0xC0);
    ST7789_WriteSmallData(0x2C);
    ST7789_WriteCommand(0xC2);
    ST7789_WriteSmallData(0x01);
    ST7789_WriteCommand(0xC3);
    ST7789_WriteSmallData(0x12);
    ST7789_WriteCommand(0xC4);
    ST7789_WriteSmallData(0x20);
    ST7789_WriteCommand(0xC6);
    ST7789_WriteSmallData(0x0F);
    ST7789_WriteCommand(0xD0);
    ST7789_WriteSmallData(0xA4);
    ST7789_WriteSmallData(0xA1);

    ST7789_WriteCommand(0xE0);
    {
        uint8_t data[] = {0xD0, 0x04, 0x0D, 0x11, 0x13, 0x2B, 0x3F, 0x54, 0x4C,
                          0x18, 0x0D, 0x0B, 0x1F, 0x23};
        HAL_SPI_Transmit(&ST7789_SPI_PORT, data, sizeof(data), HAL_MAX_DELAY);
    }

    ST7789_WriteCommand(0xE1);
    {
        uint8_t data[] = {0xD0, 0x04, 0x0C, 0x11, 0x13, 0x2C, 0x3F, 0x44, 0x51,
                          0x2F, 0x1F, 0x1F, 0x20, 0x23};
        HAL_SPI_Transmit(&ST7789_SPI_PORT, data, sizeof(data), HAL_MAX_DELAY);
    }

    ST7789_WriteCommand(ST7789_INVON);
    ST7789_WriteCommand(ST7789_SLPOUT);
    ST7789_WriteCommand(ST7789_NORON);
    ST7789_WriteCommand(ST7789_DISPON);
    HAL_Delay(50);

    ST7789_Fill_Color(BLACK);
}

void ST7789_Fill_Color(uint16_t color)
{
    uint16_t block_height;
    uint16_t swapped = (color >> 8) | (color << 8);

    ST7789_Select();

#ifdef USE_DMA
    for (uint16_t i = 0; i < ST7789_HEIGHT; i += HOR_LEN)
    {
        block_height = (i + HOR_LEN <= ST7789_HEIGHT) ? HOR_LEN : (ST7789_HEIGHT - i);
        ST7789_SetAddressWindow(0, i, ST7789_WIDTH - 1, i + block_height - 1);
        for (uint32_t k = 0; k < ST7789_WIDTH * block_height; k++) {
            disp_buf[k] = swapped;
        }
        ST7789_WriteData(disp_buf, ST7789_WIDTH * block_height);
    }
#else
    ST7789_SetAddressWindow(0, 0, ST7789_WIDTH - 1, ST7789_HEIGHT - 1);
    for (uint32_t i = 0; i < ST7789_WIDTH * ST7789_HEIGHT; i++) {
        ST7789_WriteData(&swapped, 1);
    }
#endif

    ST7789_UnSelect();
}

void ST7789_DrawPixel(uint16_t x, uint16_t y, uint16_t color)
{
    if ((x >= ST7789_WIDTH) || (y >= ST7789_HEIGHT)) return;
    ST7789_SetAddressWindow(x, y, x, y);
    uint16_t c = (color >> 8) | (color << 8);
    ST7789_WriteData(&c, 1);
}

void ST7789_DrawImage(uint16_t x, uint16_t y, uint16_t w, uint16_t h, const uint16_t *data)
{
    if ((x >= ST7789_WIDTH) || (y >= ST7789_HEIGHT)) return;
    if ((x + w - 1) >= ST7789_WIDTH) return;
    if ((y + h - 1) >= ST7789_HEIGHT) return;

    ST7789_Select();
    ST7789_SetAddressWindow(x, y, x + w - 1, y + h - 1);
    ST7789_WriteData((uint16_t *)data, w * h);
    ST7789_UnSelect();
}


void ST7789_WriteChar(uint16_t x, uint16_t y, char ch, FontDef font, uint16_t color, uint16_t bgcolor)
{
    uint32_t i, b, j;
    ST7789_Select();
    ST7789_SetAddressWindow(x, y, x + font.width - 1, y + font.height - 1);

    for (i = 0; i < font.height; i++) {
        b = font.data[(ch - 32) * font.height + i];
        for (j = 0; j < font.width; j++) {
            uint16_t pixel = ((b << j) & 0x8000) ? color : bgcolor;
            uint16_t swapped = (pixel >> 8) | (pixel << 8);
            ST7789_WriteData(&swapped, 1);
        }
    }
    ST7789_UnSelect();
}

void ST7789_Print(uint16_t y, uint16_t x, uint16_t color, uint16_t bgcolor, FontDef font, const char *str)
{
    ST7789_Select();
    while (*str) {
        if (x + font.width >= ST7789_WIDTH) {
            x = 0;
            y += font.height;
            if (y + font.height >= ST7789_HEIGHT) {
                break;
            }

            if (*str == ' ') {
                str++;
                continue;
            }
        }
        ST7789_WriteChar(x, y, *str, font, color, bgcolor);
        x += font.width;
        str++;
    }
    ST7789_UnSelect();
}
